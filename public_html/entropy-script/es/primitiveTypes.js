import{str}from"./util.js";import{ESError,TypeError}from"./errors.js";import{Position}from"./position.js";import{Node}from"./nodes.js";import{Context,ESSymbol,generateESFunctionCallContext}from"./context.js";import{global}from"./constants.js";export class ESPrimitive{constructor(e,t=types.any){this.bool=()=>this.hasOwnProperty("__bool__")?this.__bool__():new ESBoolean(!!this.__value__),this.valueOf=()=>this.__value__,this.typeOf=()=>new ESString(this.__type__.__name__),this.hasProperty=e=>this.hasOwnProperty(e.valueOf()),this.__getProperty__=e=>this.hasOwnProperty(e.valueOf())?ESPrimitive.wrap(this[e.valueOf()]):ESPrimitive.wrap(new ESUndefined),this.__type__=t||this,this.__value__=e}static wrap(e){return e instanceof ESPrimitive?e:e instanceof ESError?new ESErrorPrimitive(e):e instanceof ESSymbol?e.value:"function"==typeof e?new ESFunction(e):"number"==typeof e?new ESNumber(e):"string"==typeof e?new ESString(e):"boolean"==typeof e?new ESBoolean(e):"object"==typeof e?Array.isArray(e)?new ESArray(e):new ESObject(e):"bigint"==typeof e?new ESNumber(Number(e)):"symbol"==typeof e?new ESString(String(e)):new ESUndefined}static strip(e){if(e){if(!(e instanceof ESPrimitive))return e;if(e instanceof ESArray)return e.valueOf().map((e=>ESPrimitive.strip(e)));if(e instanceof ESObject){let t={};for(let n in e.valueOf())t[n]=ESPrimitive.strip(e.valueOf()[n]);return t}if(!(e instanceof ESUndefined))return e instanceof ESType||e instanceof ESFunction?e:e.valueOf()}}}export class ESType extends ESPrimitive{constructor(e=!1,t="(anon)",n=[],i,r){super(void 0,null==types?void 0:types.type),this.__instances__=[],this.clone=()=>{var e;return new ESType(this.__isPrimitive__,this.__name__,this.__methods__.map((e=>e.clone())),this.__extends__,null===(e=this.__init__)||void 0===e?void 0:e.clone())},this.includesType=e=>{var t,n,i,r,s,o;return!(!this.equals(types.any)&&!e.equals(types.any))||(!!(null===(t=this.__extends__)||void 0===t?void 0:t.equals(e))||(!!(null===(n=this.__extends__)||void 0===n?void 0:n.equals(types.any))||(!!(null===(i=this.__extends__)||void 0===i?void 0:i.includesType(e))||(!!(null===(r=e.__extends__)||void 0===r?void 0:r.equals(this))||(!!(null===(s=e.__extends__)||void 0===s?void 0:s.equals(types.any))||(!!(null===(o=e.__extends__)||void 0===o?void 0:o.includesType(this))||this.equals(e)))))))},this.equals=e=>e.__name__===this.__name__&&e.__isPrimitive__===this.__isPrimitive__&&Object.is(this.valueOf(),e.valueOf()),this.__call__=(e=[],t=global,n=!0,i={})=>{if(this.__isPrimitive__){if(e.length<1)return new ESUndefined;switch(this.__name__){case"UndefinedType":case"Type":return e.length<1?new ESType:e[0].typeOf();case"String":return new ESString(e[0].str().valueOf());case"Array":return new ESArray(e);case"Number":return new ESNumber(e[0].valueOf());case"Function":return new ESFunction(e[0].valueOf());case"Boolean":return new ESBoolean(e[0].bool().valueOf());case"Object":return new ESObject(e[0]);case"Error":return new ESError(Position.unknown,"UserError",e[0].str().valueOf());default:return ESPrimitive.wrap(e[0])}}const r=new Context;if(r.parent=t,void 0!==this.__extends__){let e=function e(n,i,r){const s=r.constructor;if(!i)return;if(!(i instanceof ESType))return new TypeError(Position.unknown,"Type",typeof i,i);let o=n.setOwn(new ESFunction((()=>{var n;const s=new Context;s.parent=t;let o=s.setOwn(new ESObject(r),"this");if(o instanceof ESError)return o;if(void 0!==i.__extends__){let t=e(s,i.__extends__,r);if(t instanceof ESError)return t}const _=null===(n=null==i?void 0:i.__init__)||void 0===n?void 0:n.__call__([],s);return _ instanceof ESPrimitive?_:void 0})),"super");if(o instanceof ESError)return o;const _=i.__call__([],t,!1,r);if(_ instanceof ESError)return _;(r=_.valueOf()).constructor=s}(r,this.__extends__,i);if(e instanceof ESError)return e}i.constructor=this.__init__.clone();const s=new ESObject(i);for(let e of this.__methods__){const t=e.clone();t.this_=s,i[e.name]=t}if(n&&this.__init__){this.__init__.this_=s;const t=this.__init__.__call__(e,r);if(t instanceof ESError)return t}return s.__type__=this,this.__instances__.push(s),s},this.str=()=>new ESString(`<Type: ${this.__name__}>`),this.__isPrimitive__=e,this.__name__=t,this.__name__=t,this.__extends__=i,this.__methods__=n,r?(r.name=t,this.__init__=r):this.__init__=new ESFunction(((...e)=>{const t=new Context;return t.parent=global,this.__call__(e,t,!1)}),[],t,new ESObject,types.object),types.type||(this.__type__=this)}}export class ESNumber extends ESPrimitive{constructor(e=0){super(e,types.number),this.str=()=>new ESString(this.valueOf().toString()),this.__add__=e=>e instanceof ESNumber?new ESNumber(this.valueOf()+e.valueOf()):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__subtract__=e=>e instanceof ESNumber?new ESNumber(this.valueOf()-e.valueOf()):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__multiply__=e=>e instanceof ESNumber?new ESNumber(this.valueOf()*e.valueOf()):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__divide__=e=>e instanceof ESNumber?new ESNumber(this.valueOf()/e.valueOf()):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__pow__=e=>e instanceof ESNumber?new ESNumber(Math.pow(this.valueOf(),e.valueOf())):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__eq__=e=>new ESBoolean(e instanceof ESNumber&&this.valueOf()===e.valueOf()),this.__gt__=e=>e instanceof ESNumber?new ESBoolean(this.valueOf()>e.valueOf()):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__lt__=e=>e instanceof ESNumber?new ESBoolean(this.valueOf()<e.valueOf()):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__bool__=()=>new ESBoolean(this.valueOf()>0),this.clone=()=>new ESNumber(this.valueOf())}}export class ESString extends ESPrimitive{constructor(e=""){super(e,types.string),this.str=()=>this,this.__add__=e=>e instanceof ESString?new ESString(this.valueOf()+e.valueOf()):new TypeError(Position.unknown,"String",e.typeOf().valueOf(),e.valueOf()),this.__multiply__=e=>e instanceof ESNumber?new ESString(this.valueOf().repeat(e.valueOf())):new TypeError(Position.unknown,"Number",e.typeOf().valueOf(),e.valueOf()),this.__eq__=e=>new ESBoolean(e instanceof ESString&&this.valueOf()===e.valueOf()),this.__gt__=e=>e instanceof ESString?new ESBoolean(this.valueOf().length>e.valueOf().length):new TypeError(Position.unknown,"String",e.typeOf().valueOf(),e.valueOf()),this.__lt__=e=>e instanceof ESString?new ESBoolean(this.valueOf().length<e.valueOf().length):new TypeError(Position.unknown,"String",e.typeOf().valueOf(),e.valueOf()),this.__bool__=()=>new ESBoolean(this.valueOf().length>0),this.len=()=>new ESNumber(this.valueOf().length),this.clone=()=>new ESString(this.valueOf()),this.__getProperty__=e=>{if(e instanceof ESString&&this.hasOwnProperty(e.valueOf().toString()))return this[e.valueOf().toString()];if(!(e instanceof ESNumber))return new ESString;let t=e.valueOf();for(;t<0;)t=this.valueOf().length+t;return t<this.valueOf().length?new ESString(this.valueOf()[t]):new ESString}}__setProperty__(e,t){if(!(e instanceof ESNumber))return;t instanceof ESString||(t=ESPrimitive.wrap(t));let n=e.valueOf();for(;n<0;)n=this.valueOf().length+n;const i=t.str().valueOf();let r=this.__value__.substr(0,n),s=this.__value__.substr(n+i.length);this.__value__=r+i+s}}export class ESUndefined extends ESPrimitive{constructor(){super(void 0,types.undefined),this.str=()=>new ESString("<Undefined>"),this.__eq__=e=>new ESBoolean(e instanceof ESUndefined||void 0===e||void 0===e.valueOf()),this.__bool__=()=>new ESBoolean(!1),this.clone=()=>new ESUndefined}}export class ESErrorPrimitive extends ESPrimitive{constructor(e=new ESError(Position.unknown,"Unknown","error type not specified")){super(e,types.error),this.str=()=>new ESString(`<Error: ${this.valueOf().str}>`),this.__eq__=e=>new ESBoolean(e instanceof ESErrorPrimitive&&this.valueOf().constructor===e.valueOf().constructor),this.__bool__=()=>new ESBoolean(!0),this.clone=()=>new ESErrorPrimitive(this.valueOf())}}export class ESFunction extends ESPrimitive{constructor(e=(()=>{}),t=[],n="(anonymous)",i=new ESObject,r=types.any){super(e,types.function),this.clone=()=>new ESFunction(this.__value__,this.arguments_,this.name,this.this_,this.returnType),this.valueOf=()=>this,this.str=()=>new ESString(`<Func: ${this.name}>`),this.__eq__=e=>new ESBoolean(e instanceof ESFunction&&this.__value__===e.__value__),this.__bool__=()=>new ESBoolean(!0),this.__call__=(e=[],t=global)=>{var n,i,r,s,o;const _=this.__value__;if(_ instanceof Node){const a=generateESFunctionCallContext(e,this,t);if(a instanceof ESError)return a;let l=null!==(n=this.this_)&&void 0!==n?n:new ESObject;if(!(l instanceof ESObject))return new TypeError(Position.unknown,"object",typeof l,l,"'this' must be an object");let u=a.set("this",l);if(u instanceof ESError)return u;const f=_.interpret(a);return f.error?f.error:(void 0!==f.funcReturn&&(f.val=f.funcReturn,f.funcReturn=void 0),this.returnType.includesType(null!==(r=null===(i=f.val)||void 0===i?void 0:i.__type__)&&void 0!==r?r:types.any)?f.val?f.val:new ESUndefined:new TypeError(Position.unknown,this.returnType.__name__,(null===(s=f.val)||void 0===s?void 0:s.typeOf().valueOf())||"undefined",null===(o=f.val)||void 0===o?void 0:o.str().valueOf(),"(from function return)"))}if("function"==typeof _){for(let t=e.length;t<_.length;t++)e.push(new ESUndefined);const t=_(...e);return ESPrimitive.wrap(t)}return new TypeError(Position.unknown,"function",typeof _)},this.arguments_=t,this.name=n,this.this_=i,this.returnType=r}}export class ESBoolean extends ESPrimitive{constructor(e=!1){super(e,types.bool),this.__eq__=e=>e instanceof ESBoolean?new ESBoolean(this.valueOf()===e.valueOf()):new TypeError(Position.unknown,"Boolean",e.typeOf().str().valueOf(),e.valueOf()),this.__bool__=()=>this,this.__and__=e=>new ESBoolean(this.bool().valueOf()&&e.bool().valueOf()),this.__or__=e=>new ESBoolean(this.bool().valueOf()||e.bool().valueOf()),this.str=()=>new ESString(this.valueOf()?"true":"false"),this.clone=()=>new ESBoolean(this.valueOf())}}export class ESObject extends ESPrimitive{constructor(e={}){super(e,types.object),this.str=()=>new ESString(`<ESObject: ${str(this.valueOf())}>`),this.__eq__=e=>e instanceof ESObject?new ESBoolean(this.valueOf()===e.valueOf()):new ESBoolean,this.__bool__=()=>new ESBoolean(!0),this.__getProperty__=e=>e instanceof ESString&&this.valueOf().hasOwnProperty(e.valueOf())?this.valueOf()[e.valueOf()]:this.hasOwnProperty(e.valueOf())?this[e.valueOf()]:new ESUndefined,this.clone=()=>{let e={},t=this.valueOf();for(let n in t)try{e[n]=t[n].clone()}catch(e){throw Error("Couldn't clone "+str(t[n]))}return new ESObject(e)}}__setProperty__(e,t){e instanceof ESString&&(t instanceof ESPrimitive||(t=ESPrimitive.wrap(t)),this.__value__[e.valueOf()]=t)}}export class ESArray extends ESPrimitive{constructor(e=[]){super(e,types.array),this.str=()=>new ESString(str(this.valueOf())),this.__eq__=e=>e instanceof ESArray?new ESBoolean(this.valueOf()===e.valueOf()):new ESBoolean,this.__bool__=()=>new ESBoolean(this.valueOf().length>0),this.__getProperty__=e=>{var t;if(e instanceof ESString&&this.hasOwnProperty(e.valueOf()))return this[e.valueOf()];if(!(e instanceof ESNumber))return new ESUndefined;let n=e.valueOf();for(;n<0;)n=this.valueOf().length+n;return n<this.valueOf().length?null===(t=this.valueOf()[n])||void 0===t?void 0:t.valueOf():new ESUndefined},this.add=(e,t=new ESNumber(this.len-1))=>(this.len++,this.__value__.splice(t.valueOf(),0,e),new ESNumber(this.len)),this.contains=e=>{for(let t of this.__value__)if(e.valueOf()==t.valueOf())return!0;return!1},this.clone=()=>new ESArray(this.valueOf().map((e=>e.clone()))),this.len=e.length}__setProperty__(e,t){if(!(e instanceof ESNumber))return;t instanceof ESPrimitive||(t=ESPrimitive.wrap(t));let n=e.valueOf();for(;n<0;)n=this.valueOf().length+n;this.__value__[n]=t}}export let types={};types.type=new ESType(!0,"Type"),types[void 0]=new ESType(!0,"Undefined"),types.string=new ESType(!0,"String"),types.array=new ESType(!0,"Array"),types.number=new ESType(!0,"Number"),types.any=new ESType(!0,"Any"),types.function=new ESType(!0,"Function"),types.bool=new ESType(!0,"Boolean"),types.object=new ESType(!0,"Object"),types.error=new ESType(!0,"Error");